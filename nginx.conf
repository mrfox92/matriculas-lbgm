server {
    listen 80;
    server_name localhost;

    # Directorio raíz de Laravel
    root /var/www/html/public;
    index index.php index.html;

    # -----------------------
    # 1. Seguridad básica
    # -----------------------
    location ~ /\.(?!well-known).* {
        deny all;
    }

    location ~* \.env$ {
        deny all;
    }

    location ~* \.(log|sql)$ {
        deny all;
    }

    # -----------------------
    # 2. Cache de archivos estáticos
    # -----------------------
    location ~* \.(jpg|jpeg|png|gif|svg|ico|css|js|ttf|woff|woff2)$ {
        expires 30d;
        access_log off;
        add_header Cache-Control "public, immutable";
    }

    # -----------------------
    # 3. Manejo principal de Laravel
    # -----------------------
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # -----------------------
    # 4. Manejo de PHP-FPM
    # -----------------------
    location ~ \.php$ {
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;

        fastcgi_buffer_size 32k;
        fastcgi_buffers 8 16k;
        fastcgi_busy_buffers_size 64k;
        fastcgi_temp_file_write_size 64k;
    }

    # -----------------------
    # 5. Uploads grandes
    # -----------------------
    client_max_body_size 64M;

    # -----------------------
    # 6. Rate limiting (desactivado por ahora)
    # -----------------------
    # limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;
    # location / {
    #     limit_req zone=api burst=20 nodelay;
    #     try_files $uri $uri/ /index.php?$query_string;
    # }

    # -----------------------
    # 7. Soporte para Vite
    # -----------------------
    location /build/ {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
